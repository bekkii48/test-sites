<!doctype html> <html lang="ru"> <meta charset="utf-8"> <title>Демо «как Meet»: шаринг вкладки</title> <button id="share">Поделиться страницей</button> <button id="stop" disabled>Стоп</button> <video id="preview" autoplay playsinline style="width:70vw;max-width:960px;display:block;margin-top:12px;border:1px solid #ccc;border-radius:8px"></video> <pre id="log" style="white-space:pre-wrap;background:#f7f7f9;border:1px solid #eee;border-radius:8px;padding:8px;margin-top:12px"></pre> <script> 'use strict'; const log = (...a) => { const el = document.getElementById('log'); el.textContent += a.join(' ') + '\n'; console.log(...a); }; let stream, track, controller; async function startShare() { if (!navigator.mediaDevices?.getDisplayMedia) { log('getDisplayMedia не поддерживается в этом браузере.'); return; } // Контроллер захвата + поведение фокуса (как у Meet — фокус уходит на шаримую вкладку/окно). controller = 'CaptureController' in window ? new CaptureController() : null; if (controller) { try { controller.setFocusBehavior('focus-captured-surface'); } catch (e) { log('setFocusBehavior ошибка:', e.message); } controller.oncapturedsurfacechange = () => log('Сменили общаемую поверхность (через UI браузера).'); } else { log('CaptureController недоступен — будет без управления фокусом.'); } try { stream = await navigator.mediaDevices.getDisplayMedia({ // Важные для «как Meet» хинты Chromium-браузерам: // - preferCurrentTab: предлагать текущую вкладку первой // - surfaceSwitching: позволять в дальнейшем переключать общаемую поверхность // - selfBrowserSurface: разрешить захват поверхностей этого же браузера video: { cursor: 'always' }, audio: true, // для «Share tab audio» нужно просто запросить аудио preferCurrentTab: true, surfaceSwitching: 'include', selfBrowserSurface: 'include', controller // Дополнительно (опционально, Chrome может поддерживать): // audio: { systemAudio: 'include' } // для звука системы при шаринге всего экрана (если поддерживается) }); log('Захват запущен.'); const v = document.getElementById('preview'); v.srcObject = stream; track = stream.getVideoTracks()[0]; track.onended = () => { log('Захват остановлен (пользователь/система).'); stopShare(); }; document.getElementById('share').disabled = true; document.getElementById('stop').disabled = true; // сначала недоступна — станет доступной после автоплей v.onplay = () => { document.getElementById('stop').disabled = false; }; } catch (e) { log('Пользователь отменил выбор или ошибка getDisplayMedia:', e.message); } } function stopShare() { try { if (stream) stream.getTracks().forEach(t => t.stop()); const v = document.getElementById('preview'); if (v.srcObject) v.srcObject = null; } finally { stream = null; track = null; controller = null; document.getElementById('share').disabled = false; document.getElementById('stop').disabled = true; log('Захват остановлен.'); } } document.getElementById('share').addEventListener('click', startShare); document.getElementById('stop').addEventListener('click', stopShare); </script> </html>
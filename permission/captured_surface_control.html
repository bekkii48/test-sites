<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Поп-ап «Прокрутка/масштаб вкладки» — фикс</title>
<style>
    body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    button{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:default}
    .log{white-space:pre-wrap;background:#f7f7f9;border:1px solid #eee;border-radius:10px;padding:10px;margin-top:12px;min-height:120px}
    video{display:block;width:min(70vw,900px);background:#000;border:1px solid #ddd;border-radius:10px;margin-top:10px}
</style>

<h1>Вызов системного поп-апа «Прокрутка и изменение масштаба вкладки»</h1>
<p>1) <b>Начать (вкладка)</b> → выберите <b>Вкладка Chrome</b>.<br>
    2) <b>Попросить разрешение…</b> → должен появиться поп-ап Chromium.</p>

<p>
    <button id="start">Начать (вкладка)</button>
    <button id="ask" disabled>Попросить разрешение (показать поп-ап)</button>
    <button id="stop" disabled>Стоп</button>
</p>

<video id="v" autoplay playsinline muted></video>

<h3>Логи</h3>
<div id="log" class="log"></div>

<script>
    'use strict';
    const $ = id => document.getElementById(id);
    const logEl = $('log'), vid = $('v');
    let stream=null, controller=null, capturedIsTab=false;

    function log(...a){ const s=a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' '); logEl.textContent+=s+'\n'; logEl.scrollTop=logEl.scrollHeight; console.log(...a); }
    function setRun(r){ $('start').disabled=r; $('ask').disabled=!r || !capturedIsTab; $('stop').disabled=!r; }

    (function sanity(){
      log('HTTPS/localhost:', location.protocol==='https:' || location.hostname==='localhost');
      log('CaptureController in window:', 'CaptureController' in window);
      try { log('Permissions-Policy captured-surface-control allowed:', document.permissionsPolicy?.allowsFeature?.('captured-surface-control')); } catch {}
      log('UA:', navigator.userAgent);
    })();

    async function start(){
      logEl.textContent = ''; // clear
      try{
        if (!('CaptureController' in window)) {
          log('❌ Нет CaptureController — обновите Chrome/Chromium (нужно 136+).');
        }
        controller = ('CaptureController' in window) ? new CaptureController() : null;

        const streamConstraints = {
          // ⬇️ controller MUST be top-level (NOT inside video)
          ...(controller ? { controller } : {}),
          video: {
            displaySurface: 'browser',  // prefer a tab
            cursor: 'always',
            // optional hints:
            // @ts-ignore
            preferCurrentTab: true,
            // @ts-ignore
            surfaceSwitching: 'include'
          },
          audio: true
        };

        stream = await navigator.mediaDevices.getDisplayMedia(streamConstraints);
        vid.srcObject = stream; await vid.play().catch(()=>{});
        const vt = stream.getVideoTracks()[0];
        const st = vt?.getSettings?.() || {};
        capturedIsTab = (st.displaySurface === 'browser');
        log('displaySurface =', st.displaySurface);
        if (!capturedIsTab) log('⚠️ Выбраны «Окно/Экран». Для поп-апа нужна «Вкладка Chrome».');

        vt.onended = () => { log('Видео трек завершён'); stop(); };
        setRun(true);
      } catch (e) {
        log('getDisplayMedia:', e.name, e.message);
        if (e.name==='TypeError') log('Нужен HTTPS или http://localhost.');
      }
    }

    async function ask(){
      if (!stream) { log('❌ Нет активного захвата. Нажмите «Начать (вкладка)».'); return; }
      if (!controller) { log('❌ Контроллер не создан/не передан в getDisplayMedia.'); return; }
      if (!capturedIsTab) { log('❌ Не вкладка — поп-ап не появится. Перезапустите и выберите вкладку.'); return; }

      try {
        // Any of these first calls (on user click) should trigger the permission popup:
        await controller.increaseZoomLevel();        // triggers popup the first time
        log('increaseZoomLevel(): OK (если был поп-ап — подтвердите)');

        // Start forwarding wheel events from our preview to the captured tab:
        if (controller.forwardWheel) {
          await controller.forwardWheel(vid);       // correct signature: element | null
          log('forwardWheel(vid): forwarding enabled');
        }
      } catch (e) {
        log('Запрос управления вкладкой: ', e.name, e.message);
        if (e.name === 'InvalidStateError') {
          log('▶ Это бывает, если controller НЕ прикреплён. Проверьте, что controller был передан ТОЛЬКО на верхнем уровне аргумента getDisplayMedia.');
        }
        if (e.name === 'NotAllowedError') {
          log('▶ Политика или пользователь запретили доступ (проверьте Permissions-Policy и iframe allow).');
        }
      }
    }

    function stop(){
      try{ if (stream) stream.getTracks().forEach(t=>t.stop()); if (vid.srcObject) vid.srcObject=null; }
      finally{ stream=null; controller=null; capturedIsTab=false; setRun(false); log('Остановлено.'); }
    }

    $('start').addEventListener('click', start);
    $('ask').addEventListener('click', ask);
    $('stop').addEventListener('click', stop);
</script>
</html>

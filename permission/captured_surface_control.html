<!DOCTYPE html>
<html lang="ru">
<meta charset="utf-8">
    <head>
        <style> :root { --gap: 16px; --border: 1px solid #d9d9d9; --bg: #f7f7f9; } body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #222; } h1 { margin: 0 0 var(--gap) 0; font-size: 20px; } fieldset { border: var(--border); border-radius: 8px; padding: 12px; margin-bottom: var(--gap); } legend { padding: 0 6px; color: #555; } .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; } label { display: inline-flex; align-items: center; gap: 6px; } select, button { padding: 8px 12px; } button { cursor: pointer; } .log { white-space: pre-wrap; background: var(--bg); border: var(--border); border-radius: 8px; padding: 10px; min-height: 60px; margin-bottom: var(--gap); } video { width: min(900px, 70vw); border: var(--border); border-radius: 8px; display: block; } </style>
        <title>Captured Surface Control — демо</title>
        <link rel="icon" type="image/x-icon" href="/test-sites/images/fox-icon.ico">
    </head>
    <body>
    <div id="log" class="log"></div> <fieldset> <legend>Настройки запуска</legend> <div class="row"> <label> Фокус при старте: <select id="focusBehavior"> <option value="focus-captured-surface">Переключить фокус на захваченную поверхность</option> <option value="no-focus-change">Не менять фокус</option> </select> </label> </div> <div class="row"> <label><input id="preferCurrentTab" type="checkbox" checked> preferCurrentTab</label> <label><input id="surfaceSwitching" type="checkbox" checked> surfaceSwitching: include</label> <label><input id="selfBrowserSurface" type="checkbox" checked> selfBrowserSurface: include</label> </div> </fieldset> <div class="row"> <button id="startBtn">Начать захват</button> <button id="stopBtn" disabled>Остановить</button> </div> <p></p> <video id="video" autoplay playsinline></video>
    <script> 'use strict'; // Состояние const state = { stream: null, videoTrack: null, controller: null }; // Утилиты UI const $ = (id) => document.getElementById(id); const logEl = $('log'); function log(...args) { const line = args.join(' '); logEl.textContent += line + '\n'; console.log(...args); } function setUIRunning(isRunning) { $('startBtn').disabled = isRunning; $('stopBtn').disabled = !isRunning; } // Проверка поддержки и политики разрешений function reportSupport() { const support = { getDisplayMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia), CaptureController: 'CaptureController' in window, PermissionsPolicyAPI: 'permissionsPolicy' in document }; log('Поддержка:', JSON.stringify(support)); if (document.permissionsPolicy && document.permissionsPolicy.allowsFeature) { try { const allowed = document.permissionsPolicy.allowsFeature('captured-surface-control'); log('Permissions-Policy captured-surface-control:', allowed ? 'разрешено' : 'запрещено/не настроено'); } catch (e) { log('Не удалось проверить Permissions-Policy:', e.message); } } else { log('Проверка Permissions-Policy недоступна в этом контексте.'); } } // Чтение настроек формы function readOptions() { const focusBehavior = $('focusBehavior').value; // 'focus-captured-surface' | 'no-focus-change' const preferCurrentTab = $('preferCurrentTab').checked; const surfaceSwitching = $('surfaceSwitching').checked ? 'include' : 'exclude'; const selfBrowserSurface = $('selfBrowserSurface').checked ? 'include' : 'exclude'; return { focusBehavior, preferCurrentTab, surfaceSwitching, selfBrowserSurface }; } // Старт захвата async function startCapture() { if (!navigator.mediaDevices?.getDisplayMedia) { log('Ошибка: getDisplayMedia не поддерживается.'); return; } if (!('CaptureController' in window)) { log('Ошибка: CaptureController не поддерживается. Обновите браузер или включите экспериментальные возможности.'); return; } const opts = readOptions(); // Создаём контроллер и настраиваем поведение фокуса const controller = new CaptureController(); try { controller.setFocusBehavior(opts.focusBehavior); log('setFocusBehavior:', opts.focusBehavior); } catch (e) { log('setFocusBehavior ошибка:', e.message); } controller.oncapturedsurfacechange = () => { log('Смена захваченной поверхности.'); }; try { const stream = await navigator.mediaDevices.getDisplayMedia({ video: {}, audio: false, // Расширенные опции Chromium; браузеры без поддержки просто игнорируют их preferCurrentTab: opts.preferCurrentTab, surfaceSwitching: opts.surfaceSwitching, // 'include' | 'exclude' selfBrowserSurface: opts.selfBrowserSurface, // 'include' | 'exclude' controller }); state.stream = stream; state.videoTrack = stream.getVideoTracks()[0]; state.controller = controller; const video = $('video'); video.srcObject = stream; state.videoTrack.onended = () => { log('Захват остановлен пользователем/системой.'); stopCapture(); }; setUIRunning(true); log('Захват запущен.'); } catch (e) { log('Отмена пользователем или ошибка getDisplayMedia:', e.message); } } // Остановка захвата function stopCapture() { try { if (state.videoTrack) state.videoTrack.stop(); if (state.stream) { state.stream.getTracks().forEach(t => t.stop()); } const video = $('video'); if (video.srcObject) { video.srcObject = null; } } finally { state.stream = null; state.videoTrack = null; state.controller = null; setUIRunning(false); log('Захват остановлен.'); } } // Привязка событий function bindEvents() { $('startBtn').addEventListener('click', startCapture); $('stopBtn').addEventListener('click', stopCapture); } // Инициализация (function init() { bindEvents(); reportSupport(); })(); </script>
    </body>
</html>
<!doctype html> <html lang="ru"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>Тест: прокрутка и масштаб общей вкладки (минимум)</title> <style> body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; } button { padding: 9px 14px; margin-right: 8px; cursor: pointer; } video { display: block; width: min(70vw, 960px); border: 1px solid #ccc; border-radius: 8px; margin-top: 12px; } .log { white-space: pre-wrap; background: #f7f7f9; border: 1px solid #eee; border-radius: 8px; padding: 8px; margin-top: 12px; } .block { height: 800px; border: 1px dashed #ddd; display: grid; place-items: center; color: #666; margin-top: 16px; } .row { margin-top: 8px; } </style> </head> <body> <h1>Тест: «Изменение масштаба общих вкладок и их пролистывание» (Chrome)</h1> <div class="row"> <button id="start">Начать шаринг</button> <button id="stop" disabled>Остановить</button> </div> <div class="row">Статус: <span id="status">ожидание</span></div>
<video id="preview" autoplay playsinline muted></video>

<h3>Логи</h3> <div id="log" class="log"></div> <div class="block">Прокрутите страницу (блок 1)</div> <div class="block">Блок 2</div> <div class="block">Блок 3</div> <p>Позиция прокрутки: <span id="scrollY">0</span> px</p> <p>Масштаб (visualViewport.scale): <span id="scale">—</span></p> <script> 'use strict'; const $ = id => document.getElementById(id); const logEl = $('log'); const statusEl = $('status'); const scrollEl = $('scrollY'); const scaleEl = $('scale'); let stream = null; function log(...a) { const s = a.join(' '); logEl.textContent += s + '\n'; console.log(...a); } function setRunning(on) { $('start').disabled = on; $('stop').disabled = !on; statusEl.textContent = on ? 'шаринг запущен' : 'ожидание'; } function updateIndicators() { scrollEl.textContent = Math.round(window.scrollY); if (window.visualViewport) { scaleEl.textContent = (Math.round(window.visualViewport.scale * 100) / 100).toString(); } else { scaleEl.textContent = 'нет API'; } } window.addEventListener('scroll', () => { updateIndicators(); log('scrollY:', Math.round(window.scrollY)); }, { passive: true }); if (window.visualViewport) { window.visualViewport.addEventListener('resize', () => { updateIndicators(); log('zoom scale:', window.visualViewport.scale); }); } // Минимальный, гарантированно рабочий вызов: только video/audio, без дополнительных полей async function startShare() { log('HTTPS:', location.protocol === 'https:' || location.hostname === 'localhost'); log('UserActivation before:', navigator.userActivation?.isActive); try { stream = await navigator.mediaDevices.getDisplayMedia({ video: { cursor: 'always' }, audio: true // для «Share tab audio» при выборе вкладки в пикере }); $('preview').srcObject = stream; const [vTrack] = stream.getVideoTracks(); if (vTrack) { vTrack.onended = () => { log('Захват остановлен пользователем/системой.'); stopShare(); }; } setRunning(true); updateIndicators(); log('Захват запущен. В системном пикере выберите «Вкладка Chrome» и лучше «Эта вкладка».'); log('Наводите курсор на превью и пробуйте колесо/пинч — должны прокручиваться/масштабироваться эта страница (если опция включена).'); } catch (e) { log('getDisplayMedia error:', e.name, e.message); // Подсказки по частым ошибкам if (e.name === 'NotAllowedError') log('Подсказка: проверьте, что вызов был по клику и у браузера есть права на запись экрана (macOS: Настройки → Конфиденциальность → Запись экрана).'); if (e.name === 'TypeError') log('Подсказка: нужен HTTPS или http://localhost.'); } } function stopShare() { try { if (stream) stream.getTracks().forEach(t => t.stop()); if ($('preview').srcObject) $('preview').srcObject = null; } finally { stream = null; setRunning(false); log('Шаринг остановлен.'); } } // Важное: вызывать напрямую из обработчика клика, без промежуточных await/then $('start').addEventListener('click', () => { startShare(); }); $('stop').addEventListener('click', stopShare); // Инициализация (function init() { updateIndicators(); const support = { getDisplayMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia), visualViewport: !!window.visualViewport }; log('Поддержка:', JSON.stringify(support)); })(); </script> </body> </html>
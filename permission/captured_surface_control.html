<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pop-up тест: «Прокрутка/масштаб вкладки»</title>
<style>
    body{font:14px/1.5 system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px}
    button{padding:10px 14px;border:1px solid #ddd;border-radius:10px;background:#fff;cursor:pointer}
    button:disabled{opacity:.5;cursor:default}
    .log{white-space:pre-wrap;background:#f7f7f9;border:1px solid #eee;border-radius:10px;padding:10px;margin-top:12px;min-height:120px}
    video{display:block;width:min(70vw,900px);background:#000;border:1px solid #ddd;border-radius:10px;margin-top:10px}
</style>

<h1>Вызов системного поп-апа «Прокрутка и изменение масштаба вкладки»</h1>
<p>1) Нажмите <b>«Начать (вкладка)»</b> и выберите <b>вкладку Chrome</b>.<br>
    2) Нажмите <b>«Попросить разрешение…»</b> — должен появиться стандартный поп-ап Chromium.</p>

<p>
    <button id="start">Начать (вкладка)</button>
    <button id="ask" disabled>Попросить разрешение (показать поп-ап)</button>
    <button id="stop" disabled>Стоп</button>
</p>

<video id="v" autoplay playsinline muted></video>

<h3>Логи</h3>
<div id="log" class="log"></div>

<script>
    'use strict';
    const $ = id => document.getElementById(id);
    const logEl = $('log'), vid = $('v');

    let stream = null;
    let controller = null;           // один экземпляр на страницу
    let capturedIsTab = false;
    let starting = false;            // чтобы не было гонок

    function log(...a){ const s=a.map(x=>typeof x==='object'?JSON.stringify(x):String(x)).join(' '); logEl.textContent+=s+'\n'; logEl.scrollTop=logEl.scrollHeight; console.log(...a); }
    function setRun(r){ $('start').disabled=r; $('ask').disabled=!r || !capturedIsTab; $('stop').disabled=!r; }

    function sanity(){
      const httpsOK = location.protocol==='https:' || location.hostname==='localhost';
      log('https/localhost:', httpsOK);
      const ccOK = 'CaptureController' in window;
      log('CaptureController in window:', ccOK);
      try {
        const allowed = document.permissionsPolicy?.allowsFeature?.('captured-surface-control');
        log('Permissions-Policy captured-surface-control allowed:', allowed);
      } catch(e) { /* no-op */ }
      log('UA:', navigator.userAgent);
    }
    sanity();

    async function start(){
      if (starting) return;
      starting = true;
      try{
        if (!('CaptureController' in window)) {
          log('❌ CaptureController недоступен — обновите Chrome/Chromium. Поп-ап невозможен.');
        }
        // ВАЖНО: создаём контроллер ДО вызова getDisplayMedia и переиспользуем его
        controller = ('CaptureController' in window) ? new window.CaptureController() : null;

        const constraints = {
          video: {
            displaySurface: 'browser',   // намёк на вкладку
            cursor: 'always',
            ...(controller ? { controller } : {}),
            // Подсказки Chromium (безопасно игнорируются, если не поддерживаются):
            // @ts-ignore
            preferCurrentTab: true,
            // @ts-ignore
            surfaceSwitching: 'include'
          },
          audio: true
        };

        const s = await navigator.mediaDevices.getDisplayMedia(constraints);
        stream = s; vid.srcObject = s; await vid.play().catch(()=>{});
        const vt = s.getVideoTracks()[0];
        const st = vt?.getSettings?.() || {};
        capturedIsTab = (st.displaySurface === 'browser');
        log('Получен стрим. displaySurface =', st.displaySurface);
        if (!capturedIsTab) {
          log('⚠️ Выбраны «Окно» или «Экран». Для поп-апа нужно выбрать «Вкладка Chrome».');
        }
        vt.onended = () => { log('Видео трек завершён'); stop(); };
        setRun(true);
      } catch(e){
        log('getDisplayMedia:', e.name, e.message);
        if (e.name==='TypeError') log('Нужен HTTPS или http://localhost.');
      } finally {
        starting = false;
      }
    }

    async function ask(){
      // Если пользователь нажал слишком рано — сначала стартуем захват, затем повторим запрос.
      if (!stream) {
        log('ℹ️ Захват ещё не запущен — запускаем автоматически перед запросом разрешения…');
        await start();
      }
      if (!stream) { log('❌ Нет активного захвата — запрос невозможен.'); return; }
      if (!controller) { log('❌ Нет контроллера — он должен быть передан в getDisplayMedia.'); return; }
      if (!capturedIsTab) { log('❌ Не вкладка — Chromium не покажет поп-ап. Перезапустите и выберите вкладку.'); return; }

      try {
        // В ответ на клик пользователя: вызываем контролируемое действие.
        if (controller.increaseZoomLevel) {
          await controller.increaseZoomLevel();   // ← здесь должен появиться поп-ап
          log('increaseZoomLevel(): OK (если был поп-ап — подтвердите).');
        } else {
          log('increaseZoomLevel отсутствует — пробуем forwardWheel');
        }
        if (controller.forwardWheel) {
          await controller.forwardWheel({ deltaY: 120 });
          log('forwardWheel(): OK');
        }
      } catch(e){
        log('Запрос управления вкладкой отклонён/ошибка:', e.name, e.message);
        if (e.name === 'InvalidStateError') {
          log('▶ Причина обычно в том, что контроллер не прикреплён. Убедитесь, что КОНТРОЛЛЕР был передан в getDisplayMedia и захват активен.');
        }
      }
    }

    function stop(){
      try{ if (stream) stream.getTracks().forEach(t=>t.stop()); if (vid.srcObject) vid.srcObject=null; }
      finally{ stream=null; capturedIsTab=false; setRun(false); log('Остановлено.'); }
    }

    $('start').addEventListener('click', start);
    $('ask').addEventListener('click', ask);
    $('stop').addEventListener('click', stop);
</script>
</html>

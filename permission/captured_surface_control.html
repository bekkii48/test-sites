<!doctype html> <html lang="ru"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width,initial-scale=1"> <title>Тест: прокрутка и масштаб общей вкладки (Chrome)</title> <style> body { font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 20px; } .controls { position: sticky; top: 0; background: #fff; padding: 10px 0; z-index: 1; } button { padding: 8px 14px; margin-right: 8px; cursor: pointer; } video { display: block; width: min(70vw, 960px); border: 1px solid #ccc; border-radius: 8px; } .log { white-space: pre-wrap; background: #f7f7f9; border: 1px solid #eee; border-radius: 8px; padding: 8px; } .content { margin-top: 16px; max-width: 900px; } .block { height: 800px; border: 1px dashed #ddd; display: grid; place-items: center; color: #666; margin-bottom: 16px; } .hint { color: #333; margin: 10px 0; } code { background: #f0f0f0; padding: 0 4px; border-radius: 4px; } </style> </head> <body> <h1>Тест: «Изменение масштаба общих вкладок и их пролистывание»</h1> <div class="controls"> <button id="start">Начать шаринг этой вкладки</button> <button id="stop" disabled>Остановить</button> <span id="status" class="hint"></span> </div> <div class="hint"> Инструкция: <ol> <li>Нажмите «Начать шаринг этой вкладки» и в выборе источника выберите «Эта вкладка» (This tab).</li> <li>Наведите курсор на превью (видео ниже) и: <ul> <li>крутите колёсико мыши — страница должна прокручиваться;</li> <li>пинч‑жестом на тачпаде или <code>Ctrl</code> + колесо — должен меняться масштаб (zoom) страницы.</li> </ul> </li> </ol> Если настройка в Chrome отключена, прокрутка/масштаб из превью работать не будут. </div>
<video id="preview" autoplay playsinline muted></video>
<h2>Логи</h2> <div id="log" class="log"></div> <div class="content" id="content"> <div class="block">Блок 1 (прокрутите страницу)</div> <div class="block">Блок 2</div> <div class="block">Блок 3</div> <div class="block">Блок 4</div> <div class="block">Блок 5</div> <p>Текущий масштаб (visualViewport.scale): <span id="scale">—</span></p> <p>Позиция прокрутки: <span id="scroll">—</span></p> <p>Подсказка: Для проверки масштаба попробуйте пинч на тачпаде или <code>Ctrl</code> + колесо, наведя курсор на превью.</p> </div> <script> 'use strict'; const $ = (id) => document.getElementById(id); const logEl = $('log'); const statusEl = $('status'); const scaleEl = $('scale'); const scrollEl = $('scroll'); let stream = null; let controller = null; function log(...args) { const line = args.join(' '); logEl.textContent += line + '\n'; console.log(...args); } function setRunning(running) { $('start').disabled = running; $('stop').disabled = !running; statusEl.textContent = running ? 'Шаринг запущен' : ''; } function updateScrollZoomIndicators() { const sTop = Math.round(window.scrollY); const scale = window.visualViewport ? Math.round(window.visualViewport.scale * 100) / 100 : 'нет API'; scrollEl.textContent = sTop + ' px'; scaleEl.textContent = String(scale); } // Логируем прокрутку и масштаб (если Chrome будет пересылать события, вы это увидите) window.addEventListener('scroll', () => { updateScrollZoomIndicators(); log('scrollY:', Math.round(window.scrollY)); }, { passive: true }); if (window.visualViewport) { window.visualViewport.addEventListener('resize', () => { updateScrollZoomIndicators(); log('zoom scale (visualViewport):', window.visualViewport.scale); }); } // Запуск шаринга текущей вкладки $('start').addEventListener('pointerdown', () => { // Важно: сам вызов getDisplayMedia — синхронно в этом же обработчике controller = ('CaptureController' in window) ? new CaptureController() : null; if (controller) { try { controller.setFocusBehavior('no-focus-change'); } // остаёмся на этой странице catch (e) { log('setFocusBehavior error:', e.message); } } else { log('CaptureController не поддерживается — продолжим без него.'); } const p = navigator.mediaDevices.getDisplayMedia({ video: { cursor: 'always' }, audio: false, preferCurrentTab: true, // просим показать текущую вкладку в пикере surfaceSwitching: 'include', // разрешаем переключать источник позже selfBrowserSurface: 'include', // разрешаем захват вкладок этого же браузера controller }); p.then(s => { stream = s; $('preview').srcObject = s; const [vTrack] = s.getVideoTracks(); if (vTrack) { vTrack.onended = () => { log('Захват остановлен пользователем/системой.'); stop(); }; } setRunning(true); updateScrollZoomIndicators(); log('Захват запущен. Наведите курсор на превью и попробуйте скролл/масштаб.'); log('HTTPS:', location.protocol === 'https:' || location.hostname === 'localhost'); }).catch(e => { log('getDisplayMedia error:', e.name, e.message); }); }); function stop() { if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; } const v = $('preview'); if (v.srcObject) v.srcObject = null; setRunning(false); log('Шаринг остановлен.'); } $('stop').addEventListener('click', stop); // Первичная инициализация (function init() { updateScrollZoomIndicators(); const support = { getDisplayMedia: !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia), CaptureController: 'CaptureController' in window, visualViewport: !!window.visualViewport }; log('Поддержка:', JSON.stringify(support)); })(); </script> </body> </html>